# Sparklio AI Marketing Studio - ì‹œìŠ¤í…œ ê°œì„  ê³„íšì„œ

**ì‘ì„±ì¼**: 2025-11-15
**ì‘ì„±ì**: A Team Leader
**ê¸°ë°˜ ë¬¸ì„œ**: Agent ì •ì˜ ë¬¸ì„œ 9ê°œ ì¢…í•© ê²€í† 
**ëª©ì **: Multi-Agent ì•„í‚¤í…ì²˜ í†µí•© ë° ìš´ì˜ ìµœì í™”

---

## ëª©ì°¨

1. [ì¢…í•© ê²€í†  ê²°ê³¼](#1-ì¢…í•©-ê²€í† -ê²°ê³¼)
2. [í•µì‹¬ ê°œì„ ì‚¬í•­](#2-í•µì‹¬-ê°œì„ ì‚¬í•­)
3. [ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê°•í™”](#3-ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜-ê°•í™”)
4. [ëª¨ë‹ˆí„°ë§ ë° ê´€ë¦¬ ì‹œìŠ¤í…œ](#4-ëª¨ë‹ˆí„°ë§-ë°-ê´€ë¦¬-ì‹œìŠ¤í…œ)
5. [êµ¬í˜„ ë¡œë“œë§µ](#5-êµ¬í˜„-ë¡œë“œë§µ)
6. [ê¸°ëŒ€ íš¨ê³¼](#6-ê¸°ëŒ€-íš¨ê³¼)

---

## 1. ì¢…í•© ê²€í†  ê²°ê³¼

### 1.1 ê²€í†  ë¬¸ì„œ ëª©ë¡

ë‹¤ìŒ 9ê°œ Agent ì •ì˜ ë¬¸ì„œë¥¼ ì¢…í•© ê²€í† í–ˆìŠµë‹ˆë‹¤:

1. **Multi-Agent A2A System Specification v2.1**
   - 24ê°œ Agent ì •ì˜
   - Type A/B/C ë¶„ë¥˜ (LLM Conversational / Pipeline Service / System Control)
   - 7ê°œ Agent Family êµ¬ì¡°
   - A2A í”„ë¡œí† ì½œ í‘œì¤€í™”

2. **Gemini ê²€í†  ì˜ê²¬ (GPT ë¶„ì„)**
   - PMAgent ë³µì¡ì„± ê´€ë¦¬ í•„ìš”
   - Latency ìµœì í™” (ë³‘ë ¬í™” + ë¹„ë™ê¸°)
   - Agent vs Tool êµ¬ë¶„ ëª…í™•í™”
   - ì „ëµ ì˜¤ë¥˜ ì „íŒŒ ë°©ì§€

3. **v2.2 í—¤ë” êµì²´ìš© (Planner/Executor ë¶„ë¦¬)**
   - PMAgent â†’ PlanBuilder + PlanExecutor
   - DAG ê¸°ë°˜ ì›Œí¬í”Œë¡œìš°
   - Risk-based Strategy Review
   - Latency & UX ì •ì±…

4. **ì›Œí¬í”Œë¡œìš° ìŠ¤í™ (Pydantic & PMAgent ê³¨ê²©)**
   - WorkflowSpec / WorkflowNode / WorkflowEdge
   - Celery ê¸°ë°˜ ì‹¤í–‰ ëª¨ë¸
   - ì¬ì‹œë„ / ë°±ì˜¤í”„ ì •ì±…

5. **AGENT_CONTEXT_SPEC.md**
   - 4-Layer Context ëª¨ë¸ (System / Task / Working Memory / Ephemeral)
   - Agentë³„ ì»¨í…ìŠ¤íŠ¸ ëª…ì„¸
   - A2A Context Exchange í‘œì¤€

6. **CONTEXT_ROUTING_POLICY.md**
   - SmartRouter ë¼ìš°íŒ… ê·œì¹™
   - Context Layer ìš°ì„ ìˆœìœ„
   - Context Minimization ì •ì±…

7. **EDITOR_CONTEXT_MODEL.md**
   - CanvasContext / CommandContext / EditorRules / HistoryContext
   - Action Model (12ê°œ ì¹´í…Œê³ ë¦¬)
   - Natural Language â†’ Action Parsing

8. **CONTEXT_ENGINEERING_FRAMEWORK.md**
   - ì „ì‚¬ì  Context ê´€ë¦¬ ì›ì¹™
   - Context Propagation / Lifecycle
   - TrendPipeline & Brand Learning í†µí•©

9. **Superset ëŒ€ì‹œë³´ë“œ ì„¤ê³„ í…œí”Œë¦¿**
   - 8ê°œ ë©”ê°€ ëŒ€ì‹œë³´ë“œ
   - 32ê°œ í•µì‹¬ KPI
   - DB í…Œì´ë¸” êµ¬ì¡° ê¶Œì¥ì•ˆ

### 1.2 í•µì‹¬ ë°œê²¬ì‚¬í•­

#### âœ… **ê°•ì **
- ì²´ê³„ì ì¸ Multi-Agent ì„¤ê³„ (24ê°œ Agent, ëª…í™•í•œ ì—­í•  ë¶„ë¦¬)
- Type-based ë¶„ë¥˜ë¡œ ì‹¤ì‹œê°„/ë°°ì¹˜ ì‘ì—… êµ¬ë¶„
- A2A í”„ë¡œí† ì½œ í‘œì¤€í™”
- Context Engineering ì² í•™ ëª…í™•

#### âš ï¸ **ê°œì„  í•„ìš”**
- **PMAgent ë³µì¡ë„**: ë‹¨ì¼ Agentê°€ ê³„íš + ì‹¤í–‰ ëª¨ë‘ ë‹´ë‹¹ â†’ ë¶„ë¦¬ í•„ìš”
- **Latency ë¬¸ì œ**: ìˆœì°¨ ì‹¤í–‰ ê¸°ë°˜ â†’ ë³‘ë ¬í™” + ë¹„ë™ê¸° í•„ìš”
- **Type B Agent**: ì‹¤ì‹œê°„ í”Œë¡œìš°ì— ë¶ˆí•„ìš”í•˜ê²Œ í¬í•¨ â†’ ë°°ì¹˜ ì „ìš©ìœ¼ë¡œ ê²©ë¦¬
- **ì „ëµ ì˜¤ë¥˜ ì „íŒŒ**: Strategist ì‹¤íŒ¨ ì‹œ ì „ì²´ ì‹¤íŒ¨ â†’ Review Gate í•„ìš”
- **ëª¨ë‹ˆí„°ë§ ë¶€ì¬**: í˜„ì¬ ì‹œìŠ¤í…œì— Observability ì¸í”„ë¼ ì—†ìŒ

---

## 2. í•µì‹¬ ê°œì„ ì‚¬í•­

### 2.1 PMAgent ì•„í‚¤í…ì²˜ ê°•í™”

**í˜„ì¬ ë¬¸ì œ**:
- PMAgentê°€ "ê³„íš + ì‹¤í–‰ + ëª¨ë‹ˆí„°ë§" ëª¨ë‘ ë‹´ë‹¹
- ë³µì¡ë„ ì¦ê°€ë¡œ ìœ ì§€ë³´ìˆ˜ ì–´ë ¤ì›€

**ê°œì„ ì•ˆ**:

```python
# PMAgentë¥¼ 2ê°œ ì»´í¬ë„ŒíŠ¸ë¡œ ë¶„ë¦¬

class PMAgent:
    def __init__(self):
        self.planner = PlanBuilder()      # ê³„íš ìˆ˜ë¦½
        self.executor = PlanExecutor()    # ì‹¤í–‰ ë° ëª¨ë‹ˆí„°ë§

    async def process_request(self, user_request, context):
        # 1ë‹¨ê³„: Plan ìƒì„±
        workflow_spec = await self.planner.build(user_request, context)

        # 2ë‹¨ê³„: Risk í‰ê°€ ë° Review Gate ì‚½ì…
        if workflow_spec.context.risk_level == "high":
            workflow_spec = self._inject_strategy_review(workflow_spec)

        # 3ë‹¨ê³„: ì‹¤í–‰
        job_id = await self.executor.execute(workflow_spec)

        return {"job_id": job_id, "status": "accepted"}
```

**êµ¬ì¡°**:
```
PMAgent (Coordinator)
â”œâ”€â”€ PlanBuilder (Planner)
â”‚   â”œâ”€â”€ Risk Assessment
â”‚   â”œâ”€â”€ DAG Generation
â”‚   â””â”€â”€ Pre-check (Budget, Security)
â””â”€â”€ PlanExecutor (Orchestrator)
    â”œâ”€â”€ Celery Task Distribution
    â”œâ”€â”€ Dependency Management
    â””â”€â”€ Error Handling
```

**ì´ì **:
- âœ… ë‹¨ì¼ ì±…ì„ ì›ì¹™ ì¤€ìˆ˜
- âœ… í…ŒìŠ¤íŠ¸ ìš©ì´ì„± í–¥ìƒ
- âœ… ê³„íšê³¼ ì‹¤í–‰ì„ ë…ë¦½ì ìœ¼ë¡œ ìµœì í™” ê°€ëŠ¥

---

### 2.2 Workflow DAG ê¸°ë°˜ ì‹¤í–‰ ëª¨ë¸

**í•µì‹¬**: ìˆœì°¨ ì‹¤í–‰ â†’ DAG ê¸°ë°˜ ë³‘ë ¬ ì‹¤í–‰

**ë³€ê²½ ì „** (ìˆœì°¨):
```
Strategist (3s) â†’ Copywriter (5s) â†’ VisionGenerator (10s) â†’ Reviewer (3s) â†’ Template (2s)
ì´ ì†Œìš”ì‹œê°„: 23ì´ˆ
```

**ë³€ê²½ í›„** (ë³‘ë ¬):
```
Strategist (3s)
    â”œâ”€â†’ Copywriter (5s) â”€â”
    â””â”€â†’ VisionGenerator (10s) â”€â”¤
                                â”œâ”€â†’ Reviewer (3s) â†’ Template (2s)
ì´ ì†Œìš”ì‹œê°„: 18ì´ˆ (22% ê°œì„ )
```

**WorkflowSpec JSON ì˜ˆì‹œ**:
```json
{
  "workflow_id": "uuid",
  "name": "presentation_generation",
  "context": {
    "brand_id": "uuid",
    "risk_level": "low",
    "priority": "P1"
  },
  "nodes": [
    {
      "id": "node_strategist",
      "agent": "StrategistAgent",
      "type": "llm",
      "async": true,
      "depends_on": []
    },
    {
      "id": "node_copywriter",
      "agent": "CopywriterAgent",
      "type": "llm",
      "async": true,
      "depends_on": ["node_strategist"]
    },
    {
      "id": "node_vision",
      "agent": "VisionGeneratorAgent",
      "type": "llm",
      "async": true,
      "depends_on": ["node_strategist"]
    },
    {
      "id": "node_reviewer",
      "agent": "ReviewerAgent",
      "type": "llm",
      "async": true,
      "depends_on": ["node_copywriter", "node_vision"]
    }
  ]
}
```

---

### 2.3 Risk-based Strategy Review Flow

**ë¬¸ì œ**:
- Strategistê°€ ì˜ëª»ëœ ì „ëµ ì œì‹œ â†’ ë‚˜ë¨¸ì§€ Agentê°€ ì˜ëª»ëœ ê²°ê³¼ë¬¼ ëŒ€ëŸ‰ ìƒì„±
- ë¹„ìš© + ì‹œê°„ ë‚­ë¹„

**í•´ê²°**:

**Risk Level ê³„ì‚°**:
```python
def calculate_risk_level(context):
    budget = context.get("budget", 0)
    importance = context.get("importance", "normal")
    channels = context.get("channels", [])

    # High risk ì¡°ê±´
    if budget >= 10_000_000:
        return "high"
    if importance == "critical":
        return "high"
    if "tv" in channels or "main_portal" in channels:
        return "high"

    # Medium risk ì¡°ê±´
    if budget >= 3_000_000:
        return "medium"

    return "low"
```

**High-Risk í”Œë¡œìš°**:
```
User Request
    â†“
PMAgent (risk_level = high íŒì •)
    â†“
StrategistAgent (ì „ëµ ìˆ˜ë¦½)
    â†“
[Strategy Review Gate] â† ğŸ”¥ NEW
    â”œâ”€ Human Approval (ì¤‘ìš” ìº í˜ì¸)
    â””â”€ StrategyReviewerAgent (ìë™ ê²€ì¦)
    â†“ (ìŠ¹ì¸ ì‹œ)
CopywriterAgent + VisionGeneratorAgent (ë³‘ë ¬)
    â†“
...
```

**ì´ì **:
- âœ… ì¤‘ìš” ìº í˜ì¸ í’ˆì§ˆ ë³´ì¥
- âœ… ì €ìœ„í—˜ ì‘ì—…ì€ ê¸°ì¡´ëŒ€ë¡œ ë¹ ë¥´ê²Œ ì²˜ë¦¬
- âœ… ì˜¤ë¥˜ ì¡°ê¸° ì°¨ë‹¨ (Fail Fast)

---

### 2.4 Context Engineering ì²´ê³„í™”

**4-Layer Context Model ì ìš©**:

```python
# ëª¨ë“  Agentê°€ ê³µí†µìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” Context êµ¬ì¡°

class Sparkà¤²ioContext(BaseModel):
    # Layer 1: System Context (ë¶ˆë³€)
    system: SystemContext = Field(...)

    # Layer 2: Task Context (ì‘ì—… ëª©í‘œ)
    task: TaskContext = Field(...)

    # Layer 3: Working Memory (ì¤‘ê°„ ê²°ê³¼)
    working_memory: WorkingMemory = Field(default_factory=dict)

    # Layer 4: Ephemeral Context (ì„ì‹œ)
    ephemeral: EphemeralContext = Field(default_factory=dict)

class SystemContext(BaseModel):
    brand_id: UUID
    project_id: Optional[UUID]
    task_type: str  # "presentation" / "brochure" / "video"
    risk_level: RiskLevel
    guardrails: List[str]  # ê¸ˆì§€ ê·œì¹™

class TaskContext(BaseModel):
    brief: Dict[str, Any]
    brandkit_summary: Dict[str, Any]  # ì „ì²´ê°€ ì•„ë‹Œ ìš”ì•½ë³¸ë§Œ
    user_instructions: str
    quality_gate: Dict[str, Any]

class WorkingMemory(BaseModel):
    previous_outputs: List[Dict[str, Any]]  # ìµœê·¼ 2~3ê°œë§Œ
    style_selections: Dict[str, Any]
    decisions: List[Dict[str, Any]]

class EphemeralContext(BaseModel):
    recent_conversation: List[str]  # ìµœê·¼ 3~5í„´
    temp_settings: Dict[str, Any]
```

**Context Minimization ì›ì¹™**:
```python
# âŒ ì˜ëª»ëœ ì˜ˆ: ëª¨ë“  ì •ë³´ë¥¼ ë‹¤ìŒ Agentì— ì „ë‹¬
next_agent_context = {
    "full_brandkit": brandkit,  # 10MB
    "all_history": history,      # 5MB
    "entire_conversation": conversation  # 2MB
}

# âœ… ì˜¬ë°”ë¥¸ ì˜ˆ: í•„ìš”í•œ ì •ë³´ë§Œ ì „ë‹¬
next_agent_context = {
    "brandkit_summary": {
        "colors": brandkit.colors[:3],  # ë©”ì¸ 3ê°œë§Œ
        "fonts": brandkit.fonts[:2],
        "tone": brandkit.tone
    },
    "last_output": working_memory.previous_outputs[-1],
    "user_intent": task.user_instructions
}
```

---

### 2.5 Type B Agent ê²©ë¦¬ (Pipeline Service)

**ë¬¸ì œ**:
- TrendCollector, DataCleaner, Embedder ë“± Type B Agentê°€ ì‹¤ì‹œê°„ í”Œë¡œìš°ì— í˜¼ì¬
- SmartRouterê°€ ë¶ˆí•„ìš”í•˜ê²Œ Type Bë¥¼ ë¼ìš°íŒ… í›„ë³´ë¡œ ê³ ë ¤

**í•´ê²°**:

**ëª…í™•í•œ êµ¬ë¶„**:
```python
# Type A: LLM Conversational (ì‹¤ì‹œê°„ ëŒ€í™”í˜•)
TYPE_A_AGENTS = [
    "StrategistAgent",
    "CopywriterAgent",
    "VisionGeneratorAgent",
    "ReviewerAgent",
    "TrendAgent"
]

# Type B: Pipeline Service (ë°°ì¹˜ ì „ìš©)
TYPE_B_AGENTS = [
    "TrendCollectorAgent",
    "DataCleanerAgent",
    "EmbedderAgent",
    "IngestorAgent",
    "RAGAgent"
]

# Type C: System Control
TYPE_C_AGENTS = [
    "PMAgent",
    "SecurityAgent",
    "BudgetAgent",
    "ADAgent"
]

# SmartRouterëŠ” Type A + Type Cë§Œ ë¼ìš°íŒ… ëŒ€ìƒìœ¼ë¡œ ì‚¬ìš©
class SmartRouter:
    def route(self, user_intent):
        # Type BëŠ” ì ˆëŒ€ ì„ íƒ ì•ˆ ë¨
        candidates = TYPE_A_AGENTS + TYPE_C_AGENTS
        return self._select_best(user_intent, candidates)
```

**Type BëŠ” Cron/Celery Beatë¡œ ë…ë¦½ ì‹¤í–‰**:
```python
# TrendPipelineì€ ë§¤ì¼ ìì •ì— ìë™ ì‹¤í–‰ (ì‚¬ìš©ì ìš”ì²­ê³¼ ë¬´ê´€)
@app.task
@periodic_task(run_every=crontab(hour=0, minute=0))
def run_trend_pipeline():
    """
    ë°°ì¹˜ íŒŒì´í”„ë¼ì¸: TrendCollector â†’ DataCleaner â†’ Embedder â†’ Ingestor
    """
    results = {}

    # 1. ìˆ˜ì§‘
    collected = TrendCollectorAgent().collect()
    results['collected'] = len(collected)

    # 2. ì •ì œ
    cleaned = DataCleanerAgent().clean(collected)
    results['cleaned'] = len(cleaned)

    # 3. ì„ë² ë”©
    embedded = EmbedderAgent().embed(cleaned)
    results['embedded'] = len(embedded)

    # 4. ì €ì¥
    IngestorAgent().ingest(embedded)

    logger.info(f"TrendPipeline completed: {results}")
```

---

## 3. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ê°•í™”

### 3.1 ì „ì²´ ì•„í‚¤í…ì²˜ ê°œì„ ì•ˆ

**í˜„ì¬ (AíŒ€ ì™„ë£Œ ìƒíƒœ)**:
```
3-Node Infrastructure
â”œâ”€â”€ Desktop (100.120.180.42): Ollama, ComfyUI
â”œâ”€â”€ Mac mini (100.123.51.5): PostgreSQL, Redis, MinIO, FastAPI
â””â”€â”€ Laptop (100.101.68.23): Next.js

Backend Structure
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ core/ (config, database)
â”‚   â”œâ”€â”€ models/ (asset.py)
â”‚   â”œâ”€â”€ schemas/ (asset.py)
â”‚   â”œâ”€â”€ services/ (storage.py)
â”‚   â””â”€â”€ api/v1/endpoints/ (assets.py)
```

**ê°œì„  í›„ (Multi-Agent í†µí•©)**:
```
3-Node Infrastructure (ë™ì¼)

Backend Structure
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ config.py
â”‚   â”‚   â”œâ”€â”€ database.py
â”‚   â”‚   â””â”€â”€ context.py  # ğŸ†• 4-Layer Context Model
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ asset.py
â”‚   â”‚   â”œâ”€â”€ workflow.py  # ğŸ†• WorkflowSpec
â”‚   â”‚   â””â”€â”€ agent_log.py  # ğŸ†• Agent ì‹¤í–‰ ë¡œê·¸
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ asset.py
â”‚   â”‚   â””â”€â”€ context.py  # ğŸ†• Sparkà¤²ioContext
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ storage.py
â”‚   â”‚   â””â”€â”€ smart_router.py  # ğŸ†• Agent ë¼ìš°íŒ…
â”‚   â”œâ”€â”€ agents/  # ğŸ†• Agent ë””ë ‰í† ë¦¬
â”‚   â”‚   â”œâ”€â”€ base_agent.py
â”‚   â”‚   â”œâ”€â”€ pm_agent.py  # Planner + Executor
â”‚   â”‚   â”œâ”€â”€ strategist_agent.py
â”‚   â”‚   â”œâ”€â”€ copywriter_agent.py
â”‚   â”‚   â”œâ”€â”€ vision_generator_agent.py
â”‚   â”‚   â”œâ”€â”€ reviewer_agent.py
â”‚   â”‚   â””â”€â”€ workflow_executor.py  # Celery ê¸°ë°˜ ì‹¤í–‰
â”‚   â”œâ”€â”€ pipelines/  # ğŸ†• Type B (ë°°ì¹˜ ì „ìš©)
â”‚   â”‚   â”œâ”€â”€ trend_collector.py
â”‚   â”‚   â”œâ”€â”€ data_cleaner.py
â”‚   â”‚   â”œâ”€â”€ embedder.py
â”‚   â”‚   â””â”€â”€ ingestor.py
â”‚   â””â”€â”€ api/v1/endpoints/
â”‚       â”œâ”€â”€ assets.py
â”‚       â”œâ”€â”€ workflows.py  # ğŸ†• ì›Œí¬í”Œë¡œìš° API
â”‚       â””â”€â”€ agents.py  # ğŸ†• Agent ì§ì ‘ í˜¸ì¶œ API
```

---

### 3.2 Database Schema í™•ì¥

**ì¶”ê°€ í…Œì´ë¸”**:

```sql
-- 1. Workflow ì‹¤í–‰ ì´ë ¥
CREATE TABLE workflows (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workflow_id VARCHAR(255) NOT NULL,
    name VARCHAR(255),
    status VARCHAR(20),  -- 'running', 'success', 'failed'
    context JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP,
    INDEX idx_workflow_id (workflow_id),
    INDEX idx_status (status)
);

-- 2. Agent ì‹¤í–‰ ë¡œê·¸
CREATE TABLE agent_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workflow_id VARCHAR(255),
    agent_name VARCHAR(100),
    node_id VARCHAR(100),
    input_context JSONB,
    output_result JSONB,
    status VARCHAR(20),
    latency_ms INT,
    tokens_used INT,
    cost DECIMAL(10, 6),
    model VARCHAR(50),
    error_message TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    INDEX idx_workflow_id (workflow_id),
    INDEX idx_agent_name (agent_name),
    INDEX idx_created_at (created_at)
);

-- 3. Context ì „íŒŒ ì¶”ì 
CREATE TABLE context_traces (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workflow_id VARCHAR(255),
    source_agent VARCHAR(100),
    target_agent VARCHAR(100),
    context_size_kb INT,
    layer_breakdown JSONB,  -- {system: 2kb, task: 5kb, working: 1kb}
    created_at TIMESTAMP DEFAULT NOW()
);

-- 4. TrendPipeline ì‹¤í–‰ ë¡œê·¸
CREATE TABLE trendpipeline_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    stage VARCHAR(50),  -- 'collector', 'cleaner', 'embedder', 'ingestor'
    volume INT,
    success_count INT,
    fail_count INT,
    latency_ms INT,
    created_at TIMESTAMP DEFAULT NOW(),
    INDEX idx_stage (stage),
    INDEX idx_created_at (created_at)
);

-- 5. Editor ì‚¬ìš© ë¡œê·¸
CREATE TABLE editor_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID,
    event_type VARCHAR(50),  -- 'add', 'delete', 'update', 'natural_command'
    object_id VARCHAR(100),
    command_text TEXT,
    llm_result VARCHAR(20),  -- 'success', 'fail'
    created_at TIMESTAMP DEFAULT NOW(),
    INDEX idx_user_id (user_id),
    INDEX idx_event_type (event_type)
);
```

---

## 4. ëª¨ë‹ˆí„°ë§ ë° ê´€ë¦¬ ì‹œìŠ¤í…œ

### 4.1 Superset ëŒ€ì‹œë³´ë“œ êµ¬ì„±

**8ê°œ ë©”ê°€ ëŒ€ì‹œë³´ë“œ** (Agent ì •ì˜ ë¬¸ì„œ 009 ê¸°ë°˜):

#### Dashboard 1: Global Overview
- **KPI**: DAU/WAU/MAU, ì „ì²´ ìƒì„± ìš”ì²­, ì„±ê³µë¥ , í‰ê·  ìƒì„± ì‹œê°„
- **ì°¨íŠ¸**:
  - ìƒë‹¨: KPI ì¹´ë“œ (4ê°œ)
  - ì¤‘ì•™: Pipeline Sankey Diagram (Strategist â†’ Copywriter â†’ Vision â†’ Reviewer â†’ Template)
  - í•˜ë‹¨: ì‹œê°„ëŒ€ë³„ ìš”ì²­ëŸ‰ Heatmap

#### Dashboard 2: Agent Performance
- **KPI**: Agentë³„ ì‹¤í–‰ íšŸìˆ˜, í‰ê·  Latency, ì„±ê³µë¥ , ë¹„ìš©
- **ì°¨íŠ¸**:
  - Agentë³„ Latency ë¶„í¬ (Box Plot)
  - ëª¨ë¸ë³„ ì„±ëŠ¥ ë¹„êµ (Bar Chart: GPT-4 vs Qwen vs Llama)
  - Token ì‚¬ìš©ëŸ‰ ì¶”ì´ (Line Chart)

#### Dashboard 3: Workflow Monitoring
- **KPI**: ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ íšŸìˆ˜, í‰ê·  ì†Œìš”ì‹œê°„, ë³‘ë ¬í™”ìœ¨
- **ì°¨íŠ¸**:
  - Workflow DAG ì‹œê°í™” (Network Graph)
  - ë‹¨ê³„ë³„ ë³‘ëª© êµ¬ê°„ (Gantt Chart)
  - Risk Levelë³„ ë¶„í¬ (Pie Chart)

#### Dashboard 4: TrendPipeline
- **KPI**: ìˆ˜ì§‘ëŸ‰, ì •ì œìœ¨, ì„ë² ë”© ìƒì„± íšŸìˆ˜
- **ì°¨íŠ¸**:
  - Pipeline Flow (Sankey: Collector â†’ Cleaner â†’ Embedder â†’ Ingestor)
  - ì‹œê°„ëŒ€ë³„ Trend Influx (Line Chart)

#### Dashboard 5: Context Engineering
- **KPI**: í‰ê·  Context í¬ê¸°, Layerë³„ ë¹„ìœ¨, Minimization íš¨ê³¼
- **ì°¨íŠ¸**:
  - Layerë³„ í¬ê¸° ë¶„í¬ (Stacked Bar)
  - Context ì „íŒŒ ì¶”ì  (Sankey: Agent â†’ Agent)

#### Dashboard 6: Editor Activity
- **KPI**: ëª…ë ¹ì–´ íŒŒì‹± ì„±ê³µë¥ , ìì—°ì–´ ëª…ë ¹ ë¹ˆë„
- **ì°¨íŠ¸**:
  - ëª…ë ¹ì–´ ìœ í˜• ë¶„í¬ (Pie Chart)
  - ì—ë””í„° ì´ë²¤íŠ¸ íƒ€ì„ë¼ì¸ (Timeline)

#### Dashboard 7: Cost & Budget
- **KPI**: ì¼ë³„/ì£¼ë³„/ì›”ë³„ LLM ë¹„ìš©, Agentë³„ ë¹„ìš© ë¶„ë‹´
- **ì°¨íŠ¸**:
  - ë¹„ìš© ì¶”ì´ (Line Chart)
  - ëª¨ë¸ë³„ ë¹„ìš© ë¹„êµ (Stacked Bar)

#### Dashboard 8: Error & Alerts
- **KPI**: ì—ëŸ¬ìœ¨, ì¬ì‹œë„ íšŸìˆ˜, ì‹¤íŒ¨ ì›ì¸ë³„ ë¶„í¬
- **ì°¨íŠ¸**:
  - ì—ëŸ¬ ìœ í˜•ë³„ ë¶„í¬ (Tree Map)
  - ì‹œê°„ëŒ€ë³„ ì—ëŸ¬ ë°œìƒ (Heatmap)

---

### 4.2 Prometheus + Grafana ì—°ë™

**Metrics ìˆ˜ì§‘**:
```python
# backend/app/core/metrics.py

from prometheus_client import Counter, Histogram, Gauge

# Agent ì‹¤í–‰ ë©”íŠ¸ë¦­
agent_requests_total = Counter(
    'sparklio_agent_requests_total',
    'Total agent requests',
    ['agent_name', 'status']
)

agent_latency_seconds = Histogram(
    'sparklio_agent_latency_seconds',
    'Agent execution latency',
    ['agent_name']
)

agent_tokens_used = Counter(
    'sparklio_agent_tokens_total',
    'Total tokens used',
    ['agent_name', 'model']
)

# Workflow ë©”íŠ¸ë¦­
workflow_active = Gauge(
    'sparklio_workflow_active',
    'Number of active workflows'
)

workflow_duration_seconds = Histogram(
    'sparklio_workflow_duration_seconds',
    'Workflow execution duration',
    ['workflow_name']
)

# Context ë©”íŠ¸ë¦­
context_size_bytes = Histogram(
    'sparklio_context_size_bytes',
    'Context size in bytes',
    ['layer']
)
```

**Grafana Dashboard**:
- Agent Latency (P50/P90/P99)
- Workflow Throughput
- Error Rate (5ë¶„ ë‹¨ìœ„)
- Cost per Hour
- GPU Utilization (Desktop)

---

### 4.3 Logging & Tracing

**OpenTelemetry í†µí•©**:
```python
# backend/app/core/tracing.py

from opentelemetry import trace
from opentelemetry.exporter.jaeger import JaegerExporter
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor

# Tracer ì„¤ì •
tracer_provider = TracerProvider()
jaeger_exporter = JaegerExporter(
    agent_host_name="100.123.51.5",
    agent_port=6831,
)
tracer_provider.add_span_processor(BatchSpanProcessor(jaeger_exporter))
trace.set_tracer_provider(tracer_provider)

tracer = trace.get_tracer(__name__)

# Agent ì‹¤í–‰ ì‹œ Trace
@tracer.start_as_current_span("strategist_agent_execute")
def execute_strategist(context):
    span = trace.get_current_span()
    span.set_attribute("agent.name", "StrategistAgent")
    span.set_attribute("context.size_kb", len(str(context)) / 1024)

    # Agent ì‹¤í–‰
    result = strategist.process(context)

    span.set_attribute("result.confidence", result.confidence)
    return result
```

**ì´ì **:
- âœ… ì „ì²´ ìš”ì²­ íë¦„ ì‹œê°í™” (Jaeger UI)
- âœ… ë³‘ëª© êµ¬ê°„ ìë™ íƒì§€
- âœ… Agent ê°„ ì˜ì¡´ì„± ì¶”ì 

---

## 5. êµ¬í˜„ ë¡œë“œë§µ

### Phase 1: ê¸°ë°˜ êµ¬ì¶• (1-2ì£¼)

**BíŒ€ ì‘ì—…**:
- [ ] WorkflowSpec / WorkflowNode Pydantic ëª¨ë¸ ì‘ì„±
- [ ] PMAgent ê¸°ë³¸ ê³¨ê²© (Planner + Executor)
- [ ] Workflow í…Œì´ë¸” ìƒì„± (PostgreSQL)
- [ ] Agent ë¡œê·¸ í…Œì´ë¸” ìƒì„±

**AíŒ€ ì‘ì—…**:
- [ ] Celery Beat ì„¤ì • (TrendPipeline ìŠ¤ì¼€ì¤„ë§)
- [ ] Prometheus Exporter ì„¤ì¹˜ (Mac mini)
- [ ] Grafana ì„¤ì¹˜ ë° ê¸°ë³¸ ëŒ€ì‹œë³´ë“œ

---

### Phase 2: Agent êµ¬í˜„ (2-3ì£¼)

**BíŒ€ ì‘ì—…**:
- [ ] BaseAgent í´ë˜ìŠ¤ ì‘ì„±
- [ ] StrategistAgent êµ¬í˜„
- [ ] CopywriterAgent êµ¬í˜„
- [ ] VisionGeneratorAgent êµ¬í˜„
- [ ] ReviewerAgent êµ¬í˜„
- [ ] SmartRouter ê¸°ë³¸ ë¡œì§

**AíŒ€ ì‘ì—…**:
- [ ] Ollama ëª¨ë¸ ë¡œë“œ í…ŒìŠ¤íŠ¸ (Desktop)
- [ ] ComfyUI API ì—°ë™ í…ŒìŠ¤íŠ¸

---

### Phase 3: ì›Œí¬í”Œë¡œìš° í†µí•© (1-2ì£¼)

**BíŒ€ ì‘ì—…**:
- [ ] PlanBuilder ë¡œì§ êµ¬í˜„ (DAG ìƒì„±)
- [ ] PlanExecutor ë¡œì§ êµ¬í˜„ (Celery ë¶„ë°°)
- [ ] Risk-based Strategy Review êµ¬í˜„
- [ ] Pre-check (Budget, Security)

---

### Phase 4: ëª¨ë‹ˆí„°ë§ êµ¬ì¶• (1-2ì£¼)

**AíŒ€ + BíŒ€ í˜‘ì—…**:
- [ ] Superset ì„¤ì¹˜ (Mac mini)
- [ ] 8ê°œ ëŒ€ì‹œë³´ë“œ êµ¬ì„±
- [ ] OpenTelemetry Tracing í†µí•©
- [ ] Alert ê·œì¹™ ì„¤ì • (Error rate > 5%)

---

### Phase 5: Context Engineering ì ìš© (2-3ì£¼)

**BíŒ€ ì‘ì—…**:
- [ ] 4-Layer Context Model êµ¬í˜„
- [ ] Context Minimization ë¡œì§
- [ ] Context Trace ë¡œê¹…
- [ ] TrendPipeline ë°°ì¹˜ ì „í™˜

---

## 6. ê¸°ëŒ€ íš¨ê³¼

### 6.1 ì„±ëŠ¥ ê°œì„ 

| ì§€í‘œ | í˜„ì¬ | ê°œì„  í›„ | ê°œì„ ìœ¨ |
|------|------|---------|--------|
| **í‰ê·  ìƒì„± ì‹œê°„** | 23ì´ˆ | 18ì´ˆ | 22% â†“ |
| **Agent í˜¸ì¶œ ë³µì¡ë„** | O(n) ìˆœì°¨ | O(log n) ë³‘ë ¬ | 50% â†“ |
| **Context í¬ê¸°** | í‰ê·  15KB | í‰ê·  8KB | 47% â†“ |
| **ì—ëŸ¬ ì¡°ê¸° íƒì§€** | ìµœì¢… ë‹¨ê³„ (23ì´ˆ í›„) | Pre-check (3ì´ˆ) | 87% â†“ |

---

### 6.2 ìš´ì˜ íš¨ìœ¨ì„±

| í•­ëª© | í˜„ì¬ | ê°œì„  í›„ |
|------|------|---------|
| **Agent ê´€ë¦¬** | ìˆ˜ë™ ì½”ë“œ ìˆ˜ì • | DAG JSON í¸ì§‘ |
| **ëª¨ë‹ˆí„°ë§** | ë¡œê·¸ ìˆ˜ë™ ê²€ìƒ‰ | Superset + Grafana ì‹¤ì‹œê°„ |
| **ë¹„ìš© ì¶”ì ** | ë¶ˆê°€ëŠ¥ | Agentë³„/ëª¨ë¸ë³„ ì‹¤ì‹œê°„ |
| **ë³‘ëª© íƒì§€** | ìˆ˜ì‘ì—… | OpenTelemetry ìë™ |

---

### 6.3 í’ˆì§ˆ í–¥ìƒ

| í•­ëª© | í˜„ì¬ | ê°œì„  í›„ |
|------|------|---------|
| **ì „ëµ ì˜¤ë¥˜** | ì „ì²´ ì‹¤íŒ¨ | Review Gateë¡œ ì¡°ê¸° ì°¨ë‹¨ |
| **Context ê³¼ë¶€í•˜** | ë¶ˆí•„ìš” ë°ì´í„° ì „ì†¡ | Minimization ìë™ ì ìš© |
| **Type B í˜¼ì¬** | ì‹¤ì‹œê°„ í”Œë¡œìš° ë°©í•´ | ë°°ì¹˜ ê²©ë¦¬ |

---

## 7. ë‹¤ìŒ ë‹¨ê³„

### ì¦‰ì‹œ ì°©ìˆ˜ ê°€ëŠ¥í•œ ì‘ì—…

1. **Backend êµ¬ì¡° í™•ì¥**
   ```bash
   cd ~/sparklio_ai_marketing_studio/backend
   mkdir -p app/agents app/pipelines
   ```

2. **Pydantic ëª¨ë¸ ì‘ì„±**
   - `app/models/workflow.py` (WorkflowSpec)
   - `app/schemas/context.py` (Sparkà¤²ioContext)

3. **Database Migration**
   ```sql
   -- workflows, agent_logs, context_traces í…Œì´ë¸” ìƒì„±
   ```

4. **Superset ì„¤ì¹˜**
   ```bash
   # Mac mini
   docker run -d -p 8088:8088 --name superset apache/superset
   ```

---

## ê²°ë¡ 

Agent ì •ì˜ ë¬¸ì„œ 9ê°œë¥¼ ì¢…í•© ê²€í† í•œ ê²°ê³¼, **í˜„ì¬ ìš°ë¦¬ ì‹œìŠ¤í…œì˜ ê°•ì ì„ ìœ ì§€í•˜ë©´ì„œ Multi-Agent ì•„í‚¤í…ì²˜ì˜ ì¥ì ì„ í†µí•©**í•  ìˆ˜ ìˆëŠ” ëª…í™•í•œ ë°©í–¥ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.

**í•µì‹¬ ê°œì„ ì‚¬í•­**:
1. âœ… PMAgent Planner/Executor ë¶„ë¦¬
2. âœ… DAG ê¸°ë°˜ ë³‘ë ¬ ì‹¤í–‰
3. âœ… Risk-based Strategy Review
4. âœ… Context Engineering ì²´ê³„í™”
5. âœ… Type B Agent ë°°ì¹˜ ê²©ë¦¬
6. âœ… Superset/Grafana ëª¨ë‹ˆí„°ë§

**ìš°ì„ ìˆœìœ„**:
- **High**: PMAgent êµ¬ì¡°, Workflow í…Œì´ë¸”, Agent ë¡œê·¸
- **Medium**: SmartRouter, Context Model, Monitoring
- **Low**: TrendPipeline ë°°ì¹˜ ì „í™˜

ì´ ê³„íšì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ **BíŒ€ê³¼ CíŒ€ì´ Multi-Agent ì‹œìŠ¤í…œì„ ì ì§„ì ìœ¼ë¡œ êµ¬í˜„**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

**ì‘ì„±ì¼**: 2025-11-15
**ì‘ì„±ì**: A Team Leader
**ë²„ì „**: 1.0
**ë‹¤ìŒ ë¦¬ë·°**: Phase 1 ì™„ë£Œ í›„
