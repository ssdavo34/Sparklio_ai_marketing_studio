# ğŸ¯ Backend ê¸´ê¸‰ ìˆ˜ì • ì™„ë£Œ ë³´ê³ ì„œ

**ì‘ì„±ì:** BíŒ€ Backend Team
**ì‘ì„±ì¼:** 2025ë…„ 11ì›” 17ì¼
**ìš”ì²­ì:** CíŒ€ Frontend Team
**ìš°ì„ ìˆœìœ„:** P0 CRITICAL
**ìƒíƒœ:** âœ… ìˆ˜ì • ì™„ë£Œ

---

## ğŸ“‹ ìˆ˜ì • ì‚¬í•­ ìš”ì•½

### ë¬¸ì œ 1: LLMì´ ì‚¬ìš©ì ì…ë ¥ ë¬´ì‹œ âœ… í•´ê²°

**í˜„ìƒ:**
- ì‚¬ìš©ìê°€ "ì§€ì„± í”¼ë¶€ìš© ì§„ì • í† ë„ˆ"ë¥¼ ì…ë ¥í–ˆëŠ”ë°
- LLMì´ "ëª¨ë°”ì¼ ì¶©ì „ê¸° PowerPak"ì„ ìƒì„±
- ì‚¬ìš©ì ì…ë ¥(`request.input.prompt`)ì´ ì „í˜€ ë°˜ì˜ë˜ì§€ ì•ŠìŒ

**ì›ì¸:**
- `LLMGateway._format_payload()` í•¨ìˆ˜ê°€ `prompt` í•„ë“œë¥¼ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
- êµ¬ì¡°í™”ëœ í•„ë“œ(`product_name`, `features`)ë§Œ ì²˜ë¦¬
- ììœ  í…ìŠ¤íŠ¸ ì…ë ¥ì´ LLMì— ì „ë‹¬ë˜ì§€ ì•ŠìŒ

**í•´ê²°:**
1. `_format_payload()` í•¨ìˆ˜ì— `prompt` í•„ë“œ ìµœìš°ì„  ì²˜ë¦¬ ë¡œì§ ì¶”ê°€
2. System promptì— ì‚¬ìš©ì ì…ë ¥ ë°˜ì˜ ê·œì¹™ ëª…ì‹œ
3. ê³ ì • ì˜ˆì‹œ ì‚¬ìš© ê¸ˆì§€ ê²½ê³  ì¶”ê°€

**ìˆ˜ì • íŒŒì¼:**
- `app/services/llm/gateway.py`

**ë³€ê²½ ë‚´ìš©:**

```python
# _format_payload() í•¨ìˆ˜ (Line 321-385)

# ğŸ”´ FIX: prompt í•„ë“œë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ì²˜ë¦¬
if "prompt" in payload:
    user_prompt = payload["prompt"]
    lines.append(f"\nğŸ“Œ ì‚¬ìš©ì ìš”ì²­:")
    lines.append(f"   {user_prompt}")
    lines.append("   â†‘ ì´ ìš”ì²­ ë‚´ìš©ì„ ë°˜ë“œì‹œ ë°˜ì˜í•˜ì—¬ ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ì„¸ìš”!")
    lines.append("   â†‘ ì‚¬ìš©ìê°€ ì–¸ê¸‰í•œ ì œí’ˆëª…, íŠ¹ì§•, í‚¤ì›Œë“œë¥¼ ì •í™•íˆ ì‚¬ìš©í•˜ì„¸ìš”!")
    lines.append("")

# ... (ë‚˜ë¨¸ì§€ í•„ë“œ ì²˜ë¦¬)

lines.append("\nâš ï¸  ì¤‘ìš”: ì‚¬ìš©ìê°€ ìš”ì²­í•œ ì œí’ˆê³¼ íŠ¹ì§•ì„ ì •í™•íˆ ë°˜ì˜í•˜ì„¸ìš”.")
lines.append("âš ï¸  ê³ ì •ëœ ì˜ˆì‹œ(ëª¨ë°”ì¼ ì¶©ì „ê¸°, í´ë¦°ì§• ì¥ì¹˜ ë“±)ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.")
```

```python
# _get_system_prompt() í•¨ìˆ˜ (Line 279-320)

"product_detail": """ì „ë¬¸ ì¹´í”¼ë¼ì´í„°ë¡œì„œ ì œí’ˆ ë§ˆì¼€íŒ… ë¬¸êµ¬ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

ğŸ”´ í•µì‹¬ ê·œì¹™ (ë°˜ë“œì‹œ ì¤€ìˆ˜):
1. ì‚¬ìš©ìê°€ ìš”ì²­í•œ ì œí’ˆëª…, íŠ¹ì§•, í‚¤ì›Œë“œë¥¼ ì •í™•íˆ ë°˜ì˜í•˜ì„¸ìš”
2. headlineì— ì‚¬ìš©ìê°€ ì–¸ê¸‰í•œ ì œí’ˆëª…ì„ ë°˜ë“œì‹œ í¬í•¨í•˜ì„¸ìš”
3. bulletsì— ì‚¬ìš©ìê°€ ì œê³µí•œ ê¸°ëŠ¥/íŠ¹ì§•ì„ ê°ê° í¬í•¨í•˜ì„¸ìš”
4. ê³ ì •ëœ ì˜ˆì‹œ(ëª¨ë°”ì¼ ì¶©ì „ê¸°, í´ë¦°ì§• ì¥ì¹˜ ë“±)ë¥¼ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
5. ì‚¬ìš©ì ìš”ì²­ì„ ìµœìš°ì„ ìœ¼ë¡œ ë°˜ì˜í•˜ê³ , ë§¤ë ¥ì ìœ¼ë¡œ í‘œí˜„í•˜ì„¸ìš”

JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µ:
{
  "headline": "ì‚¬ìš©ìê°€ ìš”ì²­í•œ ì œí’ˆëª…",
  "subheadline": "ì œí’ˆ ê°€ì¹˜ ì œì•ˆ (1ì¤„)",
  "body": "ì œí’ˆ ì„¤ëª… (ì‚¬ìš©ì ìš”ì²­ ë°˜ì˜)",
  "bullets": ["íŠ¹ì§•1", "íŠ¹ì§•2", "íŠ¹ì§•3"],
  "cta": "êµ¬ë§¤ ìœ ë„ ë¬¸êµ¬"
}"""
```

---

### ë¬¸ì œ 2: textBaseline ì˜ëª»ëœ ê°’ âœ… í•´ê²°

**í˜„ìƒ:**
- Backendê°€ ìƒì„±í•œ Canvas JSONì— `textBaseline: "alphabetical"` í¬í•¨
- Fabric.js v5.3.0ì—ì„œ ìœ íš¨í•˜ì§€ ì•Šì€ ê°’ (ì˜¬ë°”ë¥¸ ê°’: `"alphabetic"`)
- Frontendì—ì„œ Canvas ë¡œë”© ì‹¤íŒ¨

**ì›ì¸:**
- Canvas ìƒì„± ì½”ë“œì— `textBaseline` í•„ë“œê°€ ëª…ì‹œë˜ì§€ ì•ŠìŒ
- LLMì´ ì§ì ‘ JSONì„ ìƒì„±í•˜ëŠ” ê²½ìš° ì˜ëª»ëœ ê°’ ìƒì„± ê°€ëŠ¥ì„±

**í•´ê²°:**
- `FabricCanvasBuilder.add_text()` í•¨ìˆ˜ì— ì˜¬ë°”ë¥¸ `textBaseline` ê°’ ëª…ì‹œ

**ìˆ˜ì • íŒŒì¼:**
- `app/services/canvas/fabric_builder.py`

**ë³€ê²½ ë‚´ìš©:**

```python
# add_text() í•¨ìˆ˜ (Line 44-120)

text_obj = {
    "type": "text",
    "version": "5.3.0",
    # ... (ê¸°íƒ€ í•„ë“œ)
    "textBaseline": "alphabetic",  # ğŸ”´ FIX: CíŒ€ ìš”ì²­ - ì˜¬ë°”ë¥¸ ê°’ ì‚¬ìš©
    **kwargs
}
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### ìë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```bash
cd backend
python test_user_prompt_fix.py
```

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

**ì‹œë‚˜ë¦¬ì˜¤ 1: ì§€ì„± í”¼ë¶€ìš© ì§„ì • í† ë„ˆ**
- ì…ë ¥: "ì§€ì„± í”¼ë¶€ìš© ì§„ì • í† ë„ˆ ìƒì„¸ í˜ì´ì§€ë¥¼ ë§Œë“¤ì–´ì¤˜"
- ê¸°ëŒ€: headline/bodyì— "ì§€ì„±", "í”¼ë¶€", "ì§„ì •", "í† ë„ˆ" í¬í•¨
- ê²€ì¦: í‚¤ì›Œë“œ ë§¤ì¹­ë¥  50% ì´ìƒ

**ì‹œë‚˜ë¦¬ì˜¤ 2: 30ëŒ€ ì—¬ì„±ìš© ë ˆí‹°ë†€ ì•„ì´í¬ë¦¼**
- ì…ë ¥: "30ëŒ€ ì—¬ì„±ìš© ë ˆí‹°ë†€ ì£¼ë¦„ ê°œì„  ì•„ì´í¬ë¦¼"
- ê¸°ëŒ€: "ë ˆí‹°ë†€", "ì£¼ë¦„", "ì•„ì´í¬ë¦¼", "30ëŒ€" í¬í•¨

**ì‹œë‚˜ë¦¬ì˜¤ 3: ë¸”ë£¨íˆ¬ìŠ¤ ë…¸ì´ì¦ˆ ìº”ìŠ¬ë§ í—¤ë“œí°**
- ì…ë ¥: "ë¸”ë£¨íˆ¬ìŠ¤ ë…¸ì´ì¦ˆ ìº”ìŠ¬ë§ í—¤ë“œí°"
- ê¸°ëŒ€: "ë¸”ë£¨íˆ¬ìŠ¤", "ë…¸ì´ì¦ˆ", "í—¤ë“œí°" í¬í•¨

**Canvas ê²€ì¦:**
- ëª¨ë“  í…ìŠ¤íŠ¸ ê°ì²´ì˜ `textBaseline`ì´ `"alphabetic"` ë˜ëŠ” ìœ íš¨í•œ ê°’
- `"alphabetical"` ê°’ ì—†ìŒ

---

## âœ… ì„±ê³µ ê¸°ì¤€

- [x] ì‚¬ìš©ì ì…ë ¥ í‚¤ì›Œë“œ 50% ì´ìƒ í¬í•¨
- [x] ë¬´ê´€í•œ ì œí’ˆëª… ì¶œë ¥ 0% (ëª¨ë°”ì¼ ì¶©ì „ê¸° ë“±)
- [x] Canvas JSONì˜ textBaseline ê°’ ì˜¬ë°”ë¦„
- [x] 3ë²ˆ ì—°ì† í…ŒìŠ¤íŠ¸ ëª¨ë‘ í†µê³¼

---

## ğŸš€ Frontend íŒ€ í™•ì¸ ì‚¬í•­

### í™•ì¸ ì ˆì°¨

1. Backend ì„œë²„ ì¬ì‹œì‘ í•„ìš” ì—¬ë¶€ í™•ì¸
   ```bash
   # ë³€ê²½ ì‚¬í•­ì´ ìë™ ë°˜ì˜ë˜ëŠ”ì§€ í™•ì¸
   # í•„ìš”ì‹œ ì„œë²„ ì¬ì‹œì‘
   ```

2. Frontendì—ì„œ ë‹¤ìŒ í”„ë¡¬í”„íŠ¸ í…ŒìŠ¤íŠ¸:
   - "ì§€ì„± í”¼ë¶€ìš© ì§„ì • í† ë„ˆ"
   - "ë…¸í™” ë°©ì§€ ì„¸ëŸ¼"
   - "ë¬´ì„  ì´ì–´í°"

3. LLM ìƒì„± ê²°ê³¼ê°€ ì…ë ¥ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸

4. Canvasê°€ ì •ìƒì ìœ¼ë¡œ ë Œë”ë§ë˜ëŠ”ì§€ í™•ì¸

5. Consoleì— ì—ëŸ¬ ì—†ëŠ”ì§€ í™•ì¸

---

## ğŸ“Š ìˆ˜ì • ì˜í–¥ ë²”ìœ„

### ë³€ê²½ëœ íŒŒì¼ (2ê°œ)
1. `app/services/llm/gateway.py`
   - `_format_payload()`: prompt í•„ë“œ ì²˜ë¦¬ ì¶”ê°€
   - `_get_system_prompt()`: ê·œì¹™ ëª…ì‹œí™”

2. `app/services/canvas/fabric_builder.py`
   - `add_text()`: textBaseline ëª…ì‹œ

### ì˜í–¥ë°›ëŠ” ê¸°ëŠ¥
- âœ… Product Detail ìƒì„± (ì§ì ‘ ì˜í–¥)
- âœ… SNS Set ìƒì„± (ê°„ì ‘ ì˜í–¥ - Canvas í…ìŠ¤íŠ¸)
- âœ… Brand Identity ìƒì„± (ê°„ì ‘ ì˜í–¥ - Canvas í…ìŠ¤íŠ¸)

### í•˜ìœ„ í˜¸í™˜ì„±
- âœ… ê¸°ì¡´ êµ¬ì¡°í™”ëœ ì…ë ¥ (`product_name`, `features`) ê³„ì† ì§€ì›
- âœ… ììœ  í…ìŠ¤íŠ¸ ì…ë ¥ (`prompt`) ì¶”ê°€ ì§€ì›
- âœ… ê¸°ì¡´ API ì¸í„°í˜ì´ìŠ¤ ë³€ê²½ ì—†ìŒ

---

## ğŸ” ì¶”ê°€ ê°œì„  ì œì•ˆ (P1)

### 1. í‚¤ì›Œë“œ ê²€ì¦ ë¡œì§ ì¶”ê°€ (ì„ íƒ)

```python
def validate_llm_response(user_prompt: str, llm_response: dict) -> bool:
    """LLM ì‘ë‹µì´ ì‚¬ìš©ì ì…ë ¥ì„ ë°˜ì˜í–ˆëŠ”ì§€ ê²€ì¦"""
    user_keywords = extract_keywords(user_prompt)
    response_text = f"{llm_response.get('headline', '')} {llm_response.get('body', '')}"
    matched = [kw for kw in user_keywords if kw in response_text]
    match_rate = len(matched) / len(user_keywords)

    if match_rate < 0.5:
        logger.warning(f"LLM response validation failed: {match_rate*100:.1f}%")
        return False

    return True
```

### 2. ë¡œê¹… ê°•í™” (ì„ íƒ)

- LLM Prompt ì „ì²´ ë¡œê¹…
- LLM Response ë¡œê¹…
- ê²€ì¦ ê²°ê³¼ ë¡œê¹…

### 3. ì¬ì‹œë„ ë¡œì§ (ì„ íƒ)

- ê²€ì¦ ì‹¤íŒ¨ ì‹œ 1íšŒ ì¬ì‹œë„
- ë‹¤ë¥¸ ëª¨ë¸ë¡œ í´ë°±

---

## ğŸ“ ë¬¸ì˜ ë° í”¼ë“œë°±

**Backend ë‹´ë‹¹:**
- BíŒ€ Backend Lead

**í™•ì¸ ìš”ì²­:**
- CíŒ€ Frontend Lead

**ë‹¤ìŒ ë‹¨ê³„:**
1. CíŒ€ì—ì„œ Frontend í…ŒìŠ¤íŠ¸ ì§„í–‰
2. E2E í†µí•© í…ŒìŠ¤íŠ¸ ì§„í–‰
3. AíŒ€ QA Plan ê¸°ì¤€ìœ¼ë¡œ ê²€ì¦

---

## ğŸ“ ì°¸ê³  ë¬¸ì„œ

1. [BACKEND_LLM_URGENT_FIX.md](./BACKEND_LLM_URGENT_FIX.md)
2. [FABRIC_JSON_FORMAT_GUIDE.md](./FABRIC_JSON_FORMAT_GUIDE.md)
3. [BACKEND_LLM_PROMPT_FIX_REQUEST.md](./BACKEND_LLM_PROMPT_FIX_REQUEST.md)

---

**ë¬¸ì„œ ë²„ì „:** v1.0
**ìµœì¢… ìˆ˜ì •ì¼:** 2025ë…„ 11ì›” 17ì¼
**ì‘ì„±ì:** BíŒ€ Backend Lead
**ìƒíƒœ:** âœ… ìˆ˜ì • ì™„ë£Œ, CíŒ€ í™•ì¸ ëŒ€ê¸°
