# ğŸš¨ Backend LLM ê¸´ê¸‰ ìˆ˜ì • ìš”ì²­

**ì‘ì„±ì:** CíŒ€ Frontend Team
**ì‘ì„±ì¼:** 2025ë…„ 11ì›” 17ì¼ ì›”ìš”ì¼ 20:30
**ìµœì¢… ì—…ë°ì´íŠ¸:** 2025ë…„ 11ì›” 17ì¼ ì›”ìš”ì¼ 17:21
**ìš°ì„ ìˆœìœ„:** P0 CRITICAL
**ìƒíƒœ:** 2ê°œ ë¬¸ì œ ë°œê²¬ - (1) LLM ì…ë ¥ ë¬´ì‹œ (2) Canvas JSON ì˜ëª»ëœ ê°’

---

## ğŸ”´ ë¬¸ì œ ìƒí™©

### í…ŒìŠ¤íŠ¸ ê²°ê³¼

**ì…ë ¥ (Frontend):**
```json
{
  "kind": "product_detail",
  "brandId": "brand_demo",
  "input": {
    "prompt": "ì§€ì„± í”¼ë¶€ìš© ì§„ì • í† ë„ˆ ìƒì„¸ í˜ì´ì§€ë¥¼ ë§Œë“¤ì–´ì¤˜"
  },
  "options": {
    "tone": "professional",
    "length": "medium"
  }
}
```

**LLM ìƒì„± ê²°ê³¼ #1:**
```
ì œí’ˆëª…: "ëª¨ë°”ì¼ ì¶©ì „ê¸° PowerPak"
ì„¤ëª…: "ê³ ì† ì¶©ì „ê³¼ ê¸´ ì‚¬ìš© ì‹œê°„..."
```

**LLM ìƒì„± ê²°ê³¼ #2:**
```
ì œí’ˆëª…: "ì´ˆìŒíŒŒ í´ë¦°ì§• ì¥ì¹˜ CLEANO"
ì„¤ëª…: "ì´ˆìŒíŒŒ ê¸°ìˆ ë¡œ ëª¨ê³µ ì† ê¹Šìˆ™ì´..."
```

**LLM ìƒì„± ê²°ê³¼ #3:**
```
ë‚´ìš©: "ìŠ¤ë§ˆíŠ¸ ìœ„ì¹˜ ê°ì§€ ëª¨ë‹ˆí„°ë§ ì¼ìƒ ì†ì—ì„œì§€ ëª¨ë“  ê²ƒì„ í•œ ë²ˆì— ì±™ê²¨..."
```

---

## âŒ ë¬¸ì œì 

**ì‚¬ìš©ìê°€ "ì§€ì„± í”¼ë¶€ìš© ì§„ì • í† ë„ˆ"ë¥¼ ìš”ì²­í–ˆëŠ”ë°:**
1. ëª¨ë°”ì¼ ì¶©ì „ê¸° ìƒì„± âŒ
2. í´ë¦°ì§• ì¥ì¹˜ ìƒì„± âš ï¸ (ìŠ¤í‚¨ì¼€ì–´ ê´€ë ¨ì´ê¸´ í•˜ì§€ë§Œ í† ë„ˆ ì•„ë‹˜)
3. ìŠ¤ë§ˆíŠ¸ ìœ„ì¹˜ ê°ì§€ ëª¨ë‹ˆí„°ë§ ìƒì„± âŒ

**LLMì´ ì‚¬ìš©ì ì…ë ¥ `prompt`ë¥¼ ì „í˜€ ë°˜ì˜í•˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤.**

---

## âœ… ê¸°ëŒ€ ê²°ê³¼

**ì…ë ¥:** "ì§€ì„± í”¼ë¶€ìš© ì§„ì • í† ë„ˆ"
**ì¶œë ¥:**
```json
{
  "text": {
    "headline": "ì§€ì„± í”¼ë¶€ ì§„ì • í† ë„ˆ",
    "subheadline": "í”¼ë¶€ íŠ¸ëŸ¬ë¸” ì™„í™”, ëª¨ê³µ ì¼€ì–´",
    "body": "ì§€ì„± í”¼ë¶€ë¥¼ ìœ„í•œ ì§„ì • íš¨ê³¼ê°€ ë›°ì–´ë‚œ í† ë„ˆì…ë‹ˆë‹¤. í”¼ì§€ ì¡°ì ˆê³¼ ëª¨ê³µ ê´€ë¦¬ì— íš¨ê³¼ì ì´ë©°, ë¯¼ê°í•œ í”¼ë¶€ë„ ìê·¹ ì—†ì´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    "bullets": [
      "ì§€ì„± í”¼ë¶€ ì „ìš©",
      "í”¼ì§€ ì¡°ì ˆ",
      "ëª¨ê³µ ì¼€ì–´",
      "íŠ¸ëŸ¬ë¸” ì§„ì •"
    ],
    "cta": "ì§€ê¸ˆ êµ¬ë§¤í•˜ê¸°"
  }
}
```

---

## ğŸ” ì›ì¸ ë¶„ì„

### ê°€ëŠ¥ì„± 1: LLM Promptì— `input.prompt` ë¯¸ë°˜ì˜

**í˜„ì¬ Backend Prompt (ì¶”ì¸¡):**
```python
# CopywriterAgent
prompt = f"""
ë‹¹ì‹ ì€ ë§ˆì¼€íŒ… ì¹´í”¼ë¼ì´í„°ì…ë‹ˆë‹¤.
ì œí’ˆ ìƒì„¸ í˜ì´ì§€ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ì˜ˆì‹œ:
- ëª¨ë°”ì¼ ì¶©ì „ê¸°
- í´ë¦°ì§• ì¥ì¹˜
- ìŠ¤ë§ˆíŠ¸ ëª¨ë‹ˆí„°ë§ ì¥ì¹˜

...
"""
# ì‚¬ìš©ì ì…ë ¥ (request.input.prompt)ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ!
```

### ê°€ëŠ¥ì„± 2: LLMì´ ê³ ì •ëœ ì˜ˆì‹œë§Œ ë°˜ë³µ

Few-shot ì˜ˆì‹œê°€ ë„ˆë¬´ ê°•í•˜ê²Œ ì‘ìš©í•´ì„œ ì‚¬ìš©ì ì…ë ¥ì„ ë¬´ì‹œí•˜ê³  ì˜ˆì‹œë§Œ ë°˜ë³µ

---

## ğŸ”§ í•´ê²° ë°©ë²•

### 1ë‹¨ê³„: Promptì— ì‚¬ìš©ì ì…ë ¥ ëª…ì‹œ

```python
# backend/app/agents/copywriter.py (ë˜ëŠ” í•´ë‹¹ íŒŒì¼)

def generate_product_detail(request: GenerateRequest) -> dict:
    # ì‚¬ìš©ì ì…ë ¥ ì¶”ì¶œ
    user_prompt = request.input.get("prompt", "")

    # LLM Prompt êµ¬ì„±
    llm_prompt = f"""
ë‹¹ì‹ ì€ ë§ˆì¼€íŒ… ì¹´í”¼ë¼ì´í„°ì…ë‹ˆë‹¤.

ì‚¬ìš©ì ìš”ì²­:
{user_prompt}

ìœ„ ìš”ì²­ì— ëŒ€í•œ ì œí’ˆ ìƒì„¸ í˜ì´ì§€ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ì¤‘ìš”:
1. ë°˜ë“œì‹œ ì‚¬ìš©ìê°€ ìš”ì²­í•œ ì œí’ˆì— ëŒ€í•´ì„œë§Œ ì‘ì„±í•˜ì„¸ìš”
2. ì˜ˆì‹œë¥¼ ê·¸ëŒ€ë¡œ ë³µì‚¬í•˜ì§€ ë§ˆì„¸ìš”
3. ì‚¬ìš©ì ìš”ì²­ì—ì„œ ì–¸ê¸‰ëœ í‚¤ì›Œë“œë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì„¸ìš”

ì¶œë ¥ í˜•ì‹ (JSON):
{{
  "headline": "ì‚¬ìš©ìê°€ ìš”ì²­í•œ ì œí’ˆëª…",
  "subheadline": "ì œí’ˆì˜ í•µì‹¬ ê°€ì¹˜ ì œì•ˆ",
  "body": "ì œí’ˆ ì„¤ëª… (ì‚¬ìš©ì ìš”ì²­ ë‚´ìš© ë°˜ì˜)",
  "bullets": ["íŠ¹ì§•1", "íŠ¹ì§•2", "íŠ¹ì§•3"],
  "cta": "êµ¬ë§¤í•˜ê¸°"
}}
"""

    # LLM í˜¸ì¶œ
    response = llm.invoke(llm_prompt)

    return parse_llm_response(response)
```

---

### 2ë‹¨ê³„: LLM ì‘ë‹µ ê²€ì¦

```python
def validate_llm_response(user_prompt: str, llm_response: dict) -> bool:
    """LLM ì‘ë‹µì´ ì‚¬ìš©ì ì…ë ¥ì„ ë°˜ì˜í–ˆëŠ”ì§€ ê²€ì¦"""

    # ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ì—ì„œ í•µì‹¬ í‚¤ì›Œë“œ ì¶”ì¶œ
    # ì˜ˆ: "ì§€ì„± í”¼ë¶€ìš© ì§„ì • í† ë„ˆ" â†’ ["ì§€ì„±", "í”¼ë¶€", "ì§„ì •", "í† ë„ˆ"]
    user_keywords = extract_keywords(user_prompt)

    # LLM ì‘ë‹µ í…ìŠ¤íŠ¸
    response_text = f"{llm_response.get('headline', '')} {llm_response.get('body', '')}"

    # í‚¤ì›Œë“œ ë§¤ì¹­ í™•ì¸
    matched_keywords = [kw for kw in user_keywords if kw in response_text]

    # ìµœì†Œ 50% ì´ìƒì˜ í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ì•¼ í•¨
    match_rate = len(matched_keywords) / len(user_keywords)

    if match_rate < 0.5:
        logger.warning(f"LLM response validation failed!")
        logger.warning(f"User keywords: {user_keywords}")
        logger.warning(f"Matched: {matched_keywords} ({match_rate*100:.1f}%)")
        logger.warning(f"Response: {response_text[:200]}")
        return False

    return True

# ì‚¬ìš©
llm_response = generate_product_detail(request)

if not validate_llm_response(request.input.get("prompt"), llm_response):
    # ì¬ì‹œë„ ë˜ëŠ” ì—ëŸ¬ ë°˜í™˜
    raise ValueError("LLM failed to reflect user input")
```

---

### 3ë‹¨ê³„: ë¡œê¹… ê°•í™”

```python
# LLM í˜¸ì¶œ ì „í›„ ë¡œê¹…
logger.info("=" * 80)
logger.info("LLM PROMPT:")
logger.info(llm_prompt)
logger.info("=" * 80)

response = llm.invoke(llm_prompt)

logger.info("=" * 80)
logger.info("LLM RESPONSE:")
logger.info(json.dumps(response, indent=2, ensure_ascii=False))
logger.info("=" * 80)
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ì œí’ˆëª…ë§Œ

**ì…ë ¥:**
```
ì§€ì„± í”¼ë¶€ìš© ì§„ì • í† ë„ˆ
```

**ê¸°ëŒ€ ì¶œë ¥:**
```json
{
  "headline": "ì§€ì„± í”¼ë¶€ ì§„ì • í† ë„ˆ",
  "body": "ì§€ì„± í”¼ë¶€... ì§„ì •... í† ë„ˆ...",
  "bullets": ["ì§€ì„± í”¼ë¶€", "ì§„ì • íš¨ê³¼", "í† ë„ˆ"]
}
```

**ê²€ì¦:**
- âœ… "ì§€ì„±", "í”¼ë¶€", "ì§„ì •", "í† ë„ˆ" í‚¤ì›Œë“œ í¬í•¨
- âŒ "ëª¨ë°”ì¼", "ì¶©ì „ê¸°", "í´ë¦°ì§•", "ëª¨ë‹ˆí„°ë§" ë“± ë¬´ê´€í•œ í‚¤ì›Œë“œ ì—†ìŒ

---

### ì‹œë‚˜ë¦¬ì˜¤ 2: ìƒì„¸ ì„¤ëª…

**ì…ë ¥:**
```
30ëŒ€ ì—¬ì„±ìš© ë ˆí‹°ë†€ ì£¼ë¦„ ê°œì„  ì•„ì´í¬ë¦¼
```

**ê¸°ëŒ€ ì¶œë ¥:**
```json
{
  "headline": "ë ˆí‹°ë†€ ì£¼ë¦„ ê°œì„  ì•„ì´í¬ë¦¼",
  "subheadline": "30ëŒ€ ì—¬ì„±ì„ ìœ„í•œ ì§‘ì¤‘ ì¼€ì–´",
  "body": "ë ˆí‹°ë†€ ì„±ë¶„ì´... ì£¼ë¦„ ê°œì„ ... ì•„ì´í¬ë¦¼...",
  "bullets": ["ë ˆí‹°ë†€ í•¨ìœ ", "ì£¼ë¦„ ê°œì„ ", "30ëŒ€ ì—¬ì„±ìš©"]
}
```

**ê²€ì¦:**
- âœ… "ë ˆí‹°ë†€", "ì£¼ë¦„", "ì•„ì´í¬ë¦¼", "30ëŒ€", "ì—¬ì„±" í‚¤ì›Œë“œ í¬í•¨
- âŒ ë¬´ê´€í•œ ì œí’ˆ ì–¸ê¸‰ ì—†ìŒ

---

### ì‹œë‚˜ë¦¬ì˜¤ 3: ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬

**ì…ë ¥:**
```
ë¸”ë£¨íˆ¬ìŠ¤ ë…¸ì´ì¦ˆ ìº”ìŠ¬ë§ í—¤ë“œí°
```

**ê¸°ëŒ€ ì¶œë ¥:**
```json
{
  "headline": "ë¸”ë£¨íˆ¬ìŠ¤ ë…¸ì´ì¦ˆ ìº”ìŠ¬ë§ í—¤ë“œí°",
  "body": "ë¸”ë£¨íˆ¬ìŠ¤... ë…¸ì´ì¦ˆ ìº”ìŠ¬ë§... í—¤ë“œí°...",
  "bullets": ["ë¸”ë£¨íˆ¬ìŠ¤", "ë…¸ì´ì¦ˆ ìº”ìŠ¬ë§", "ë¬´ì„ "]
}
```

**ê²€ì¦:**
- âœ… "ë¸”ë£¨íˆ¬ìŠ¤", "ë…¸ì´ì¦ˆ ìº”ìŠ¬ë§", "í—¤ë“œí°" í‚¤ì›Œë“œ í¬í•¨
- âŒ "ìŠ¤í‚¨ì¼€ì–´", "í† ë„ˆ", "ì¶©ì „ê¸°" ë“± ë¬´ê´€í•œ í‚¤ì›Œë“œ ì—†ìŒ

---

## ğŸ“Š ì„±ê³µ ê¸°ì¤€

- âœ… ì‚¬ìš©ì ì…ë ¥ í‚¤ì›Œë“œ 50% ì´ìƒ í¬í•¨
- âœ… ë¬´ê´€í•œ ì œí’ˆëª… ì¶œë ¥ 0%
- âœ… 3ë²ˆ ì—°ì† í…ŒìŠ¤íŠ¸ ëª¨ë‘ í†µê³¼

---

## ğŸš€ ê¸´ê¸‰ ìš”ì²­

**Backend íŒ€ì— ìš”ì²­:**

1. **ì¦‰ì‹œ LLM Prompt ìˆ˜ì •**
   - `request.input.prompt`ë¥¼ ëª…ì‹œì ìœ¼ë¡œ í¬í•¨
   - ê³ ì •ëœ ì˜ˆì‹œ ì œê±° ë˜ëŠ” ì•½í™”

2. **ê²€ì¦ ë¡œì§ ì¶”ê°€**
   - í‚¤ì›Œë“œ ë§¤ì¹­ í™•ì¸
   - ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë˜ëŠ” ì—ëŸ¬

3. **ë¡œê¹… ì¶”ê°€**
   - LLM Prompt ì „ì²´
   - LLM Response ì „ì²´
   - ê²€ì¦ ê²°ê³¼

**ì˜ˆìƒ ì†Œìš” ì‹œê°„:** 1~2ì‹œê°„

---

## ğŸ“ Frontend ëŒ€ê¸° ìƒíƒœ

CíŒ€ì€ ëª¨ë“  êµ¬í˜„ ì™„ë£Œ ìƒíƒœì…ë‹ˆë‹¤.

**ëŒ€ê¸° ì¤‘:**
- Backend LLM Prompt ìˆ˜ì •

**ì¤€ë¹„ ì™„ë£Œ:**
- API ì—°ë™ 100%
- Canvas ë Œë”ë§ 100%
- E2E íë¦„ 100%

---

**ë¬¸ì„œ ë²„ì „:** v1.0
**ìµœì¢… ìˆ˜ì •ì¼:** 2025ë…„ 11ì›” 17ì¼ ì›”ìš”ì¼ 20:30
**ì‘ì„±ì:** CíŒ€ Frontend Lead
**ê²€í† ì:** BíŒ€ Backend Lead (ì¦‰ì‹œ í™•ì¸ ìš”ì²­)
